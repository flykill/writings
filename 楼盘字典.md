# 房源录入与楼盘字典校验

## 问题

目前如果遇到录入的房源在链家楼盘字典不存在的情况，无法录入，只能通过联系链家团队人工建盘之后才能录入。速度太慢，满足不了租房快速流转的需求。

## 楼盘字典现状

* 计划开放建盘以及更新的 API，但无明确时间点
* 楼盘字典现在支持30个城市，进入新城市之前可以提前通知楼盘字典团队，这样我们可以基于其数据进行维护，但不依赖其数据
* 楼盘字典计划使用新的数据库结构，同样没有明确时间点。我们需要将新的表结构要过来，分析一下影响。我们要马上开始开发，所以使用现有的楼盘字典数据库结构

## 方案

* 建立丁丁自己的楼盘字典
* 链家楼盘字典不存在的房源，允许录入，先放到丁丁楼盘字典里
* 定期从链家同步数据，一天一次
* [技术方案](#技术方案)

## 场景：房源录入

### 业主录入、扒房（经纪人、400）

* 首先依据楼盘字典校验7项数据：城市、城区、小区、楼栋、楼层、单元、门牌号
	* 业主录入的时候，朝向、户型、面积不由系统带出（防止被扒）
	* 经纪人、400录入时必须严格使用楼盘字典的数据，从界面上的列表中选择
	* Idea: 给13项信息分配权重，物业地址权重高，最后根据得分来判定是否直接上架、需要审核、或不通过
* 如果通过校验，并且通过信息审核，直接上架
* 如果没通过校验，系统自动触发建盘流程，同时该房源进入审核员界面
* 审核员即使通过审核，如果尚未建盘，房源也不能上架

### 建盘流程

* 丁丁成立一个楼盘系统维护团队
* 系统触发流程后，楼盘系统团队接受任务，去考察这个新小区，只扫楼，不强求进屋；主要目的是快速获取小区的楼栋和房间信息，以及小区照片，面积、户型图等不强求
* 在楼盘系统里把信息和照片录入（在录入时先选小区、再录房屋信息，提供联想功能防止重复录入，小区别名功能）
* 根据楼栋、楼层、单元、门牌号把某个房源对应的商品状态改为「通过校验」
* 楼盘团队需要受理纠错服务（如，业主联系400告诉某项信息错误，比如地图的位置）
* 时间？至少需要一天吧。

### 代理商录入（自如、青客）、系统对接（SE、德祐）

* 代理商通过接口（由丁丁定义）把房源信息发送过来，先进行简单的信息审核之后上架（不管楼盘字典是否校验通过）
* 我们会要求对方发送比业主委托更多的信息（比如小区信息）
	* 未通过校验的就是我们缺失的，系统会自动建盘，后续由楼盘团队跟进，可以更新楼盘信息
* 如果在建盘之前成交，我们仍需继续补全、更新楼盘信息，为了以后使用

## 场景：房屋信息修改

* 城市、小区名不能改
* 业主自己修改物业地址，同录入流程
* 业主修改信息，不直接回写楼盘字典，系统报警，由楼盘字典团队跟进（和录入错误信息流程一致）
* 业主修改无需审核的信息，如面积、户型，商品信息自动更新，对应的楼盘字典信息同时更新
* 业主修改房源照片和描述，经过审核后更新商品信息

## 场景：楼盘字典信息修改

是否同步修改商品信息？

* 只要信息跟业主核实过，不修改
* 其他房子，自动修改房屋信息

## 场景：合租

* 楼盘字典里不维护房间信息
* 房源列表里按间展示，同时展示其他房间的信息
* 房间信息不需要校验，只要标识带不带卫生间、阳台，是否主卧、次卧

## 问题

1. 从链家楼盘字典同步过来的数据和丁丁自己的数据怎么合并？（可否只导一次，然后不再与链家同步？）
	* 10号2万多套，12号200多套，13、14号1万套左右。这么多数据，物业地址包含的五项信息完全匹配的几率感觉上很小（因为输入格式没有要求），但实际上因为楼盘字典对北京的覆盖很多都会是同样的楼盘。
	* 楼盘字典导入的数据，逐条与我们现有的字典数据比对
		* 相同的：参考此[合并规则](#合并规则)
			* 相同怎么定义？
				* 城市、城区相等，小区名相等或为别名（楼盘字典里有别名字段），楼栋、楼层、单元、门牌号相等或者为 1、一、壹
		* 相似的：城市、城区相同的，并且小区名称相似，系统报警，人工处理
			* 拼音相同
			* 名称互相包含（A包含B，或者B包含A）
		* 不同的：直接导入丁丁楼盘系统
2. 暂不考虑丁丁往楼盘字典回推

## 质疑

* 建盘速度慢的问题真的能得到解决吗？
* 线下团队的职责、角色比以前更多
	* 楼盘维护的团队，主要是建盘、更新
	* 手工处理数据的团队来解决跟链家楼盘字典合并的问题，以及代理商的数据与丁丁数据合并问题
	
## 技术方案

* 使用一张表来存储楼盘词典信息。先全量导入链家的，然后给每条记录分配一个丁丁生成的ID。![image](http://7mnlla.com1.z0.glb.clouddn.com/solution1.png)
* 每天同步的增量需要一张表暂存
* 更新不会插入新记录
* 记录字段修改时间（mongodb）
* 操作记录表

## 合并规则

字段级别的合并规则：

* 如果丁丁为空，以链家的值填充
* 如果丁丁没改，链家改过，以链家为准
* 如果丁丁改了，链家没改，以丁丁为准
* 如果都修改过，按照丁丁修改时间的五天内以丁丁为准，五天以链家为准
