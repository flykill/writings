# 房源录入与楼盘字典校验

## 问题

目前如果遇到录入的房源在链家楼盘字典不存在的情况，无法录入，只能通过联系链家团队人工建盘之后才能录入。速度太慢，满足不了租房快速流转的需求。

## 楼盘字典现状

* 计划开放建盘以及更新的 API，但无明确时间点
* 楼盘字典现在支持30个城市，进入新城市之前可以提前通知楼盘字典团队，这样我们可以基于其数据进行维护，但不依赖其数据
* 楼盘字典计划使用新的数据库结构，同样没有明确时间点。我们需要将新的表结构要过来，分析一下影响。我们要马上开始开发，所以使用现有的楼盘字典数据库结构

## 方案

* 建立丁丁自己的楼盘字典
* 链家楼盘字典不存在的房源，允许录入，先放到丁丁楼盘字典里
* 定期从链家同步数据，一天一次
* [技术方案](#技术方案)

## 房源录入、审核及建盘流程
![image](http://7mnlla.com1.z0.glb.clouddn.com/house_inbound.png)

### 楼盘字典校验规则

无论是业主、代理商还是管家录入的房源，都按下面的规则进行楼盘字典校验：

1. 城市：必须相等（录入端为选择项）
2. 小区：必须相等（录入端为根据输入联想，小区别名也能联想）
3. 楼栋：1、一、1号楼、1号、1座、1栋、1幢认为相同
4. 单元：1、一、1单元、1幢、1门、1门栋认为相同（上海选填、不校验）
5. 楼层：1、一、1层、1楼、负1层、-1、-1层、地下1层、B1、B1层认为相同（上海选填、不校验）
6. 门牌号：1、一、1号、1室认为相同

### 建盘流程注意事项

1. 管家实地考察物业地址是否真实存在
2. 在管家端建盘：
	* 先判断小区是否建过，是否有照片，有的话可以直接进入下一步
	* 楼栋、单元、楼层、门牌号确认（此时房源可上架），允许管家将小区名称添加为别名
	* 增加此小区其他楼栋、门牌号信息（可选）

### 重盘判断规则

1. 管家不可以录入重复房源
2. 400电销不可以录入重复房源
3. 业主端不可以录入与代理商重复的房源
4. 业主端可以录入或其他业主端重复的房源，但不上架，由审核员审核
5. 业主端可以录入与管家或400重复的房源，审核通过上架后，下架其他重复的房源
6. 代理商不可以录入与其他代理商重复的房源
7. 代理商可以录入与管家、400、业主重复的房源，审核通过上架后，下架其他重复的房源

注：重复房源指的是与状态为「待租中」的房源重复

### 需要建盘人提供什么信息？

1. 城市、小区、楼栋、单元、楼层、门牌号
2. 小区照片（包含小区名称、环境照片）
3. 地理位置标注（在地图上点一个点）

## 楼盘字典信息修改

是否同步修改商品信息？

* 只要信息跟业主核实过，不修改
* 其他房子，自动修改房屋信息

## 合租

* 楼盘字典里不维护房间信息
* 房源列表里按间展示，同时展示其他房间的信息
* 房间信息不需要校验，只要标识带不带卫生间、阳台，是否主卧、次卧

## 问题

1. 从链家楼盘字典同步过来的数据和丁丁自己的数据怎么合并？（可否只导一次，然后不再与链家同步？）
	* 10号2万多套，12号200多套，13、14号1万套左右。这么多数据，物业地址包含的五项信息完全匹配的几率感觉上很小（因为输入格式没有要求），但实际上因为楼盘字典对北京的覆盖很多都会是同样的楼盘。
	* 楼盘字典导入的数据，逐条与我们现有的字典数据比对
		* 相同的：参考此[合并规则](#合并规则)
			* 相同怎么定义？
				* 城市、城区相等，小区名相等或为别名（楼盘字典里有别名字段），楼栋、楼层、单元、门牌号相等或者为 1、一、壹
		* 相似的：城市、城区相同的，并且小区名称相似，系统报警，人工处理
			* 拼音相同
			* 名称互相包含（A包含B，或者B包含A）
		* 不同的：直接导入丁丁楼盘系统
2. 暂不考虑丁丁往楼盘字典回推
3. 线下团队的职责、角色比以前多
	* 楼盘维护的团队：主要是建盘、更新
	* 处理数据的团队：解决跟链家楼盘字典数据、代理商导入数据合并的问题
	
## 技术方案

* 使用一张表来存储楼盘词典信息。先全量导入链家的，然后给每条记录分配一个丁丁生成的ID。![image](http://7mnlla.com1.z0.glb.clouddn.com/solution1.png)
* 每天同步的增量需要一张表暂存
* 更新不会插入新记录
* 记录字段修改时间（mongodb）
* 操作记录表

## 合并规则

字段级别的合并规则：

* 如果丁丁为空，以链家的值填充
* 如果丁丁没改，链家改过，以链家为准
* 如果丁丁改了，链家没改，以丁丁为准
* 如果都修改过，按照丁丁修改时间的五天内以丁丁为准，五天以链家为准
